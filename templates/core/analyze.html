{% extends 'base/base.html' %}
{% load static %}

{% block title %}Text Analysis - DeepMindCheck{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold text-gradient">AI Text Analysis</h1>
                <p class="lead text-muted">Enter your text below for instant mental health analysis</p>
            </div>
            
            <div class="analysis-interface">
                <form id="analysisForm">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label for="textInput" class="form-label fw-semibold">
                            <i class="fas fa-edit text-primary me-2"></i>Your Text
                        </label>
                        <textarea 
                            class="form-control text-input" 
                            id="textInput" 
                            rows="8"
                            placeholder="Share your thoughts, feelings, or experiences here..."
                            required>
                        </textarea>
                        <div id="charCount" class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>Minimum 10 characters required
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="modelSelect" class="form-label fw-semibold">
                                <i class="fas fa-cog text-primary me-2"></i>Analysis Model
                            </label>
                            <select class="form-select" id="modelSelect">
                                <option value="baseline" selected>Baseline Model (Recommended)</option>
                                <option value="advanced">Advanced Model</option>
                                <option value="ensemble">Ensemble Model</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-sliders-h text-primary me-2"></i>Options
                            </label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="includeExplanation">
                                <label class="form-check-label" for="includeExplanation">
                                    Include detailed explanation
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg px-5" id="analyzeBtn">
                            <i class="fas fa-brain me-2"></i>Analyze Text
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg px-4 ms-3" id="clearBtn">
                            <i class="fas fa-eraser me-2"></i>Clear
                        </button>
                    </div>
                </form>
                
                <!-- Loading Spinner -->
                <div id="loadingSpinner" class="loading-spinner" style="display: none;">
                    <div class="spinner-custom"></div>
                    <h5>Analyzing your text...</h5>
                    <p class="text-muted">This may take a few moments</p>
                </div>
                
                <!-- Results Container -->
                <div id="results" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Important Disclaimer -->
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="alert alert-warning border-0">
                <h6 class="fw-bold mb-2">
                    <i class="fas fa-exclamation-triangle me-2"></i>Important Disclaimer
                </h6>
                <p class="mb-0">
                    This tool is for educational and awareness purposes only. It is not a substitute 
                    for professional medical advice, diagnosis, or treatment. If you're experiencing 
                    mental health concerns, please consult with a qualified healthcare provider.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('analysisForm');
    const textInput = document.getElementById('textInput');
    const charCount = document.getElementById('charCount');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultsDiv = document.getElementById('results');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const clearBtn = document.getElementById('clearBtn');
    
    // Character counter
    textInput.addEventListener('input', updateCharCount);
    
    function updateCharCount() {
        const length = textInput.value.length;
        const remaining = 2000 - length;
        
        if (length < 10) {
            const needed = 10 - length;
            charCount.innerHTML = `<i class="fas fa-info-circle me-1"></i>${needed} more characters needed (${length}/10+)`;
            charCount.className = 'form-text text-warning';
        } else if (length > 2000) {
            charCount.innerHTML = `<i class="fas fa-exclamation-triangle me-1"></i>Text too long! Remove ${-remaining} characters (${length}/2000)`;
            charCount.className = 'form-text text-danger';
        } else {
            charCount.innerHTML = `<i class="fas fa-check-circle me-1"></i>Ready for analysis! (${length} characters, ${remaining} remaining)`;
            charCount.className = 'form-text text-success';
        }
    }
    
    // Clear button
    clearBtn.addEventListener('click', function() {
        textInput.value = '';
        updateCharCount();
        resultsDiv.style.display = 'none';
    });
    
    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const text = textInput.value.trim();
        const model = document.getElementById('modelSelect').value;
        const explain = document.getElementById('includeExplanation').checked;
        
        // Validation
        if (text.length < 10) {
            alert('Please enter at least 10 characters');
            return;
        }
        
        if (text.length > 2000) {
            alert('Text is too long. Maximum 2000 characters allowed');
            return;
        }
        
        // Show loading
        loadingSpinner.style.display = 'block';
        resultsDiv.style.display = 'none';
        analyzeBtn.disabled = true;
        
        try {
            const response = await fetch('/api/analyze/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    text: text,
                    model: model,
                    explain: explain
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                displayResults(data);
            } else {
                throw new Error(data.error || 'Analysis failed');
            }
            
        } catch (error) {
            showError(error.message);
        } finally {
            loadingSpinner.style.display = 'none';
            analyzeBtn.disabled = false;
        }
    });
    
    function displayResults(data) {
        const confidenceLevel = data.confidence > 0.8 ? 'high' : data.confidence > 0.6 ? 'medium' : 'low';
        const predictionClass = `result-${data.prediction}`;
        
        let html = `
            <div class="card ${predictionClass} result-card mt-4">
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h4 class="card-title mb-3">
                                <i class="fas fa-clipboard-check text-primary me-2"></i>
                                Analysis Results
                            </h4>
                            
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="feature-icon icon-${data.prediction} me-3" style="width: 60px; height: 60px;">
                                            <i class="fas ${getPredictionIcon(data.prediction)}"></i>
                                        </div>
                                        <div>
                                            <h5 class="mb-0 text-capitalize">${data.prediction}</h5>
                                            <small class="text-muted">Primary Classification</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-sm-6">
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="fw-semibold">Confidence</span>
                                            <span class="fw-bold">${(data.confidence * 100).toFixed(1)}%</span>
                                        </div>
                                        <div class="confidence-bar">
                                            <div class="confidence-fill ${confidenceLevel}" style="width: ${data.confidence * 100}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="bg-light rounded p-3 mb-2">
                                    <div class="text-muted small">Model Used</div>
                                    <div class="fw-bold text-primary">${data.model_used}</div>
                                </div>
                                <div class="bg-light rounded p-3 mb-2">
                                    <div class="text-muted small">Response Time</div>
                                    <div class="fw-bold text-success">${data.processing_time}s</div>
                                </div>
                                <div class="bg-light rounded p-3">
                                    <div class="text-muted small">Text Length</div>
                                    <div class="fw-bold text-info">${data.text_length} chars</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info border-0 mb-4">
                        <i class="fas fa-info-circle me-2"></i>${data.message}
                    </div>
                    
                    <!-- Probabilities -->
                    <div class="mt-4">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-chart-bar text-info me-2"></i>Detailed Probabilities
                        </h6>
                        <div class="row">
                            ${Object.entries(data.probabilities).map(([label, prob]) => `
                                <div class="col-md-4 mb-3">
                                    <div class="text-center">
                                        <div class="fw-semibold text-capitalize mb-1">${label}</div>
                                        <div class="progress mb-1" style="height: 10px;">
                                            <div class="progress-bar bg-primary" style="width: ${prob * 100}%"></div>
                                        </div>
                                        <small class="text-muted">${(prob * 100).toFixed(1)}%</small>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Recommendations -->
                    ${data.recommendations && data.recommendations.length > 0 ? `
                        <div class="mt-4">
                            <h6 class="fw-bold mb-3">
                                <i class="fas fa-heart text-danger me-2"></i>Recommendations
                            </h6>
                            <div class="bg-light rounded p-3">
                                ${data.recommendations.map(rec => `
                                    <div class="d-flex align-items-start mb-2">
                                        <i class="fas fa-arrow-right text-primary me-2 mt-1"></i>
                                        <span>${rec}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Explanation -->
                    ${data.explanation ? `
                        <div class="mt-4">
                            <h6 class="fw-bold mb-3">
                                <i class="fas fa-lightbulb text-warning me-2"></i>Detailed Explanation
                            </h6>
                            <div class="bg-light rounded p-3">
                                <p class="mb-2"><strong>Analysis Reasoning:</strong> ${data.explanation.reasoning}</p>
                                <p class="mb-2"><strong>Confidence Details:</strong> ${data.explanation.confidence_explanation}</p>
                                <small class="text-muted">${data.explanation.disclaimer}</small>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Feedback -->
                    <div class="mt-4 pt-4 border-top">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-thumbs-up text-success me-2"></i>Rate This Analysis
                        </h6>
                        <div class="text-center">
                            <div class="rating-stars mb-3" data-analysis-id="${data.id}">
                                ${[1, 2, 3, 4, 5].map(rating => 
                                    `<span class="star" data-rating="${rating}">⭐</span>`
                                ).join('')}
                            </div>
                            <p class="text-muted small">Your feedback helps improve our AI models</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        resultsDiv.innerHTML = html;
        resultsDiv.style.display = 'block';
        resultsDiv.scrollIntoView({ behavior: 'smooth' });
        
        // Add rating functionality
        document.querySelectorAll('.star').forEach(star => {
            star.addEventListener('click', function() {
                const rating = this.dataset.rating;
                const analysisId = this.parentElement.dataset.analysisId;
                submitRating(analysisId, rating);
            });
        });
    }
    
    function getPredictionIcon(prediction) {
        const icons = {
            neutral: 'fa-smile',
            depression: 'fa-frown',
            anxiety: 'fa-exclamation-triangle'
        };
        return icons[prediction] || 'fa-question-circle';
    }
    
    function showError(message) {
        resultsDiv.innerHTML = `
            <div class="alert alert-danger border-0 mt-4">
                <div class="d-flex">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger me-3"></i>
                    <div>
                        <h5 class="alert-heading">Analysis Error</h5>
                        <p class="mb-0">${message}</p>
                    </div>
                </div>
            </div>
        `;
        resultsDiv.style.display = 'block';
    }
    
    async function submitRating(analysisId, rating) {
        try {
            const response = await fetch('/api/feedback/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    analysis_id: analysisId,
                    rating: parseInt(rating)
                })
            });
            
            if (response.ok) {
                alert('Thank you for your feedback!');
                // Highlight selected stars
                document.querySelectorAll('.star').forEach((star, index) => {
                    star.style.color = index < rating ? '#fbbf24' : '#ddd';
                });
            }
        } catch (error) {
            console.error('Failed to submit rating:', error);
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Initialize
    updateCharCount();
});
</script>
{% endblock %}